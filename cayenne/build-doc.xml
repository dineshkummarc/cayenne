<?xml version="1.0"?>

<!-- ================================================= -->
<!--         Cayenne documentation buildfile.          -->
<!--             (called from build.xml)               -->
<!-- ================================================= -->
<project name="cayenne-doc" default="doc" basedir=".">	  
    <path id="classpath">
    	<pathelement path="${ant.home}/lib/ant.jar"/>
        <fileset dir="otherlib">
            <include name="**.jar"/>
        </fileset>
    </path>
    

    <!-- ============================================= -->
    <!-- Deploys Cayenne web site in a local directory -->
    <!-- ============================================= -->
    <target name="release-site" depends="nositedir,prepare,doc,api">
    	 <delete dir="${site.dir}/cayenne"/>
         <mkdir dir="${site.dir}/cayenne"/>
         
         <!-- copy tutorial distros -->
         <antcall target="tutorial-dist">
        	<param name="tutorial.name" value="cayenne-cmd-app"/>
         </antcall>
         <antcall target="tutorial-dist">
        	<param name="tutorial.name" value="cayenne-web-app"/>
         </antcall>
         
         
         <!-- copy all but HTML -->
         <copy todir="${site.dir}/cayenne">
             <fileset dir="${dist}/doc"> 
             	<exclude name="**/*.html"/>
             </fileset>
         </copy>
         
         <!-- do replacement in HTML files -->
         <copy todir="${site.dir}/cayenne">
             <fileset dir="${dist}/doc"> 
             	<include name="**/*.html"/>
             </fileset>
             
             <filterset begintoken="!--" endtoken="--">
				<filter token="SFLOGO" value="${sf.logo}"/>
			 </filterset>
         </copy>
    </target>
    
    
    <!-- ========================================== -->
    <!-- Creates documentation directories.         -->
    <!-- ========================================== -->
    <target name="prepare">
        <tstamp/>
        <mkdir dir="${dist}/doc"/>
        <mkdir dir="${dist}/doc/api"/>
        <mkdir dir="${dist}/doc/dtd"/>
        <mkdir dir="${dist}/doc/tutorial"/>
    </target>    


    <!-- ========================================== -->
    <!-- Cleans distribution files and subprojects. -->
    <!-- ========================================== -->
    <target name="clean">
        <delete dir="${dist}/doc"/>
    </target>
    
    <!-- ========================================== -->
    <!-- Creates a fulldocumentation build.         -->
    <!-- ========================================== -->
    <target name="dist-src" depends="doc,api,tutorials"/>
    

    <!-- ========================================== -->
    <!-- Builds Cayenne documenatation.             -->
    <!-- ========================================== -->
    <target name="doc" depends="prepare,doc-img">
        <!-- copy all licenses & release notes -->
        <copy todir="${dist}/doc">
            <fileset dir="doc/licenses">
               <include name="**"/>
            </fileset>
            
            <fileset dir="doc/release-notes">
               <include name="RELEASE-NOTES-*.txt"/>
            </fileset>
        </copy>

        <taskdef name="anakia" classname="org.apache.velocity.anakia.AnakiaTask">
            <classpath refid="classpath"/>
        </taskdef>
        
        <!-- Build site -->
        <anakia basedir="xdocs" destdir="${dist}/doc"
             extension=".html" style="cayenne.vsl"
             projectFile="stylesheets/project.xml"
             excludes="**/stylesheets/**"
             includes="**/*.xml"
             lastModifiedCheck="true"
             templatePath="xdocs/stylesheets">
        </anakia>
        
        <!-- copy DTD's -->
        <copy todir="${dist}/doc/dtd">
            <fileset dir="src/cayenne/dtd">
                <include name="**/*.dtd"/>
            </fileset>
        </copy>
    </target>
    
    
    <!-- ========================================== -->
    <!-- Distributes Cayenne tutorials.             -->
    <!-- ========================================== -->
    <target name="tutorials" depends="prepare">
        <antcall target="tutorial-src">
        	<param name="tutorial.name" value="cayenne-cmd-app"/>
        </antcall>
        <antcall target="tutorial-src">
        	<param name="tutorial.name" value="cayenne-web-app"/>
        </antcall>
    </target>
    
    
    <!-- ========================================== -->
    <!-- Distributes a single Cayenne tutorial.     -->
    <!-- ========================================== -->
    <target name="tutorial-src" if="tutorial.name">
        <!-- copy unpacked tutorial files -->
        <copy todir="${dist}/doc/tutorial" filtering="no">
            <fileset dir="doc/tutorial">
            	<include name="${tutorial.name}/**"/>
            </fileset>
        </copy>
    </target>
    
    <target name="tutorial-dist" if="tutorial.name">
        <!-- package tutorial files for single click download -->
        <tar tarfile="${dist}/doc/tutorial/${tutorial.name}.tar">
            <tarfileset dir="${dist}/doc/tutorial">
               <include name="${tutorial.name}/**"/>
               
               <!-- exclude files that should be autogenerated by Cayenne -->
               <exclude name="**/*Artist.java"/>
               <exclude name="**/*Painting.java"/>
               <exclude name="**/*Gallery.java"/>
            </tarfileset>
        </tar>
        <gzip src="${dist}/doc/tutorial/${tutorial.name}.tar" 
              zipfile="${dist}/doc/tutorial/${tutorial.name}.tar.gz"/>  
        <delete file="${dist}/doc/tutorial/${tutorial.name}.tar"/>
    </target>
    
    
    <!-- ========================================== -->
    <!-- Copies documentation images in the target  -->
    <!-- directory.                                 -->
    <!-- ========================================== -->
    <target name="doc-img">
        <!-- copy images -->
        <copy todir="${dist}/doc/images" filtering="no">
            <fileset dir="xdocs/images">
                <include name="**/*.gif"/>
                <include name="**/*.jpeg"/>
                <include name="**/*.jpg"/>
                <include name="**/*.css"/>
            </fileset>
        </copy>
    </target>


    <!-- ========================================== -->
    <!-- Lazy API documenatation build.             -->
    <!-- ========================================== -->
    <target name="api" depends="check-api,build-api"/>
    
    <target name="build-api" depends="prepare,doc-img" unless="api.up2date">
        <javadoc    packagenames="org.objectstyle.*"
                    sourcepath="src/cayenne/java"
                    defaultexcludes="yes"
                    destdir="${dist}/doc/api"
                    author="true"
                    use="true"
                    windowtitle="Cayenne API">
            <!-- Exclude PostgreSQL for the interim release -->
            <excludepackage name="org.objectstyle.cayenne.dba.postgres"/>
            
            <group title="Core Packages" packages="org.objectstyle.*"/>
            <group title="WebObjects Compatibility Packages" packages="org.objectstyle.cayenne.wocompat*"/>
			<group title="GUI Packages" packages="org.objectstyle.cayenne.gui*"/>
            <doctitle><![CDATA[<h2><a href="http://objectstyle.org/cayenne/" target="_top">
            		<img height="40" border="0" src="../images/cayenne_logo_small.gif"><a> 
            		Cayenne API Documentation (Version ${project.version})</h2>]]></doctitle>
            <bottom><![CDATA[<!--SFLOGO--> &nbsp; <i>Copyright &#169; 2001-2002 <a href=
            "http://objectstyle.org" target="_top">ObjectStyle.org</a> All Rights Reserved.</i>]]>
            </bottom>
            <classpath refid="classpath"/>
        </javadoc>
    </target>
    
    <target name="check-api">
		<uptodate property="api.up2date" targetfile="${dist}/doc/api/index.html" >
			<srcfiles dir= "src/cayenne/java" includes="**/*.java"/>
		</uptodate>
    </target>
    
    <target name="nositedir" unless="site.dir">
    	<fail>"site.dir" must be defined.</fail>
    </target>
</project>


