<document>
<title>User Guide - Writing Cayenne Applications</title>

    <properties>
        <author>Andrei Adamchik</author>
    </properties>
<navigator>
	<up>/userguide/index.html</up>
	<prev>/userguide/appguide/exp.html</prev>
	<next>/userguide/modeler/index.html</next>
</navigator>    
<body>
     <section name="4. Writing Cayenne Applications" toc="/userguide/index.html">        
        <subsection name="4.6 Deployment" anchor="deploy">
           <p>As described in <a href="project.html">Cayenne Project</a>
           chapter, a Cayenne application would need access to <code>cayenne.xml</code>
           file, data map file(s) and (optionally) datasource file(s). These files are
           located and loaded by the application 
           <a href="../design.html#config">Configuration object</a>. Depending on which
           concrete subclass of Configuration is used, configuration files are located 
           differently. Below is a few standard deployment scenarious. Cayenne users
           may subclass Configuration to define other loading strategies.
           </p>
           
           <subsection name="4.6.1 Standalone Applications" anchor="standalone">
               <p>In a standalone Java application, normally a <a href=
               "../../api/org/objectstyle/cayenne/conf/DefaultConfiguration.html">DefaultConfiguration</a> 
                will be used to locate and load configuration files. This approach
                does not require any special Java code. Shared configuration objects
                can simply be obtained by calling <code>getSharedConfig</code>:</p>
                
<source>import org.objectstyle.cayenne.conf.Configuration;
...           
Configuration conf = Configuration.getSharedConfig();
</source>
              <p>DefaultConfiguration will expect <code>cayenne.xml</code> file to be located 
              in the CLASSPATH. Same is true for datamaps referenced in <code>cayenne.xml</code>.
              Their location is resolved relative to CLASSPATH as well. To make these files available to
              Cayenne, you can simply include them in the root of your application jar file. 
              </p>
              
              <p>Location of the datasource files referenced in <code>cayenne.xml</code>
              depends on what factory was assigned to each datasource in <code>cayenne.xml</code>.
              Normally this would be a <a href=
               "../../api/org/objectstyle/cayenne/conf/DriverDataSourceFactory.html"
               >org.objectstyle.cayenne.conf.DriverDataSourceFactory</a>. It would use
               the following lookup order to resolve location:
               
               <ul>
                  <li>Location is assumed to be a file relative to the user HOME 
                  directory (as defined by <code>user.home</code> system property).</li>
                  <li>Location is assumed to be a file relative to the current directory
                  from which the application was started.</li>
                  <li>Location is assumed to be a resource relative to CLASSPATH.</li>
               </ul>
               
               This lookup order makes configuration very flexible in that it separates
               datasource configuration files from the application distribution (jar file).
               A compiled application can be deployed as a jar file containing <code>cayenne.xml</code>
               and datamap files, without any datasource files.  This way a user wouldn't
               need to rebuild a jar for each of target environments that has a different database server.
               </p>
               
               <p>
               Simple use case for this feature is when a Java project needs to be deployed
               in development, test, and production environments. All a deployer would need to
               do is to create datasource files in the home directory of each of the servers. After that
               the same jar file can be deployed on any of them without any changes. 
               Another benefit of a separate datasource file is that database user name 
               and password information are not
               stored with the application (possibly in a shared repository) 
               and instead stored on each deployment machine. This provides better security.
              </p>

           </subsection>
           
           <subsection name="4.6.2 Web Applications" anchor="web">
               <p>Though it is possible to use the procedure described for the standalone applications
               when deploying an application in a web container, Cayenne provides a better way
               to do that. Suggested way is to use <a href=
               "../../api/org/objectstyle/cayenne/conf/ServletConfiguration.html"
               >ServletConfiguration</a> subclass of Configuration. It does <code>cayenne.xml</code>
               and datamap files lookup relative to the WEB-INF directory of a deployed application.
               Since WEB-INF is a standard place to put configuration files, this approach makes
               configuration cleaner and more maintainable.
               <i>Note that it will NOT search the CLASSPATH for configuration files.</i>              
               </p>
               
               <p>Suggested way to configure datasources is to use <a href=
               "../../api/org/objectstyle/cayenne/conf/JNDIDataSourceFactory.html"
               >JNDIDataSourceFactory</a> as a factory in <code>cayenne.xml</code> file
               and rely on container to provide a datasource via JNDI. Of course using
               DriverDataSourceFactory is also possible.</p>              

               
               <p>Another feature of ServletConfiguration that does not exist in a standalone 
               configuration is the ability to automatically assign a DataContext object to every 
               new HttpSession created within the application. If this feature is configured, a
               user can access DataContext the using following code:
               </p>
               
<source>
import org.objectstyle.cayenne.conf.ServletConfiguration;
import javax.servlet.http.HttpServletRequest;
...

// assume this exists
HttpServletRequest r;

// get session DataContext to perform database queries
DataContext ctxt = ServletConfiguration.getDefaultContext(r.getSession());
</source>
                <panel name="Note:">
                Automatic ServletConfiguration setup is possible only in containers that
                implement Servlet Specification version 2.3 (such as Tomcat 4.0.x). 
                Earilier versions of the spec (implemented by Tomcat 3.3 for instance)
                don't have javax.servlet.http.HttpSessionListener
                and javax.servlet.ServletContext listener interfaces needed for
                this feature. When using an older container, a user will need to
                set ServletConfiguration as a shared Configuration object herself.
                Creation of a DataContext in the session will also be a responsibility of a user.
                </panel>
                
                <p>Here is an extract from a sample web application deployment descriptor (web.xml file). 
                It tells the container that ServletConfiguration class will serve as a listener
                of session and context events. It also declares a JNDI resource named 
                "jdbc/mydb" of type "javax.sql.DataSource". This should work with any container
                compliant with Servlet Specification version 2.3.
                </p>
                
<source>...

&amp;lt;listener&amp;gt;
   &amp;lt;listener-class&amp;gt;org.objectstyle.cayenne.conf.ServletConfiguration&amp;lt;/listener-class&amp;gt;
&amp;lt;/listener&amp;gt; 

...

&amp;lt;resource-ref&amp;gt;
   &amp;lt;res-ref-name&gt;jdbc/mydb&amp;lt;/res-ref-name&amp;gt;
   &amp;lt;res-type&gt;javax.sql.DataSource&amp;lt;/res-type&amp;gt;
   &amp;lt;res-auth&gt;Container&amp;lt;/res-auth&amp;gt;
&amp;lt;/resource-ref&amp;gt;
...</source>
                
             <p>For the users of Tomcat 4.0.x, here is a sample configuration of a single
             web application context that makes a datasource available to this web application
             under the JNDI name "jdbc/mydb". <i>Note that configuration
             below is most certainly incompatible with other containers and will work with Tomcat
             only.</i> This code may be inserted in $CATALINA_HOME/conf/server.xml file between 
             the &lt;Host&gt;...&lt;/Host&gt; tags.
             </p>
<source>
&amp;lt;Context path="/myapp" docBase="myapp" debug="1" reloadable="true" crossContext="true"&amp;gt;
    &amp;lt;Logger className="org.apache.catalina.logger.FileLogger" 
                   prefix="myapp-log." 
                   suffix=".txt" 
                   timestamp="true"/&amp;gt;
   
    &amp;lt;ResourceParams name="jdbc/mydb"&amp;gt;
            &amp;lt;parameter&amp;gt;
                &amp;lt;name&amp;gt;factory&amp;lt;/name&amp;gt;
                &amp;lt;value&amp;gt;org.objectstyle.cayenne.conn.ContainerPoolFactory&amp;lt;/value&amp;gt;
            &amp;lt;/parameter&amp;gt;
            
            &amp;lt;parameter&amp;gt;
                &amp;lt;name&amp;gt;username&amp;lt;/name&amp;gt;
                &amp;lt;value&amp;gt;user&amp;lt;/value&amp;gt;
            &amp;lt;/parameter&amp;gt;
            
            &amp;lt;parameter&amp;gt;
                &amp;lt;name&amp;gt;password&amp;lt;/name&amp;gt;
                &amp;lt;value&amp;gt;bla-bla&amp;lt;/value&amp;gt;
            &amp;lt;/parameter&amp;gt;
                
            &amp;lt;parameter&amp;gt;
                &amp;lt;name&amp;gt;driver&amp;lt;/name&amp;gt;
                &amp;lt;value&amp;gt;org.gjt.mm.mysql.Driver&amp;lt;/value&amp;gt;
            &amp;lt;/parameter&amp;gt;
            
            &amp;lt;parameter&amp;gt;
                &amp;lt;name&amp;gt;url&amp;lt;/name&amp;gt;
                &amp;lt;value&amp;gt;jdbc:mysql://dbserver/mydb&amp;lt;/value&amp;gt;
            &amp;lt;/parameter&amp;gt;
            
            &amp;lt;parameter&amp;gt;
                &amp;lt;name&amp;gt;min&amp;lt;/name&amp;gt;
                &amp;lt;value&amp;gt;1&amp;lt;/value&amp;gt;
            &amp;lt;/parameter&amp;gt;
            
            &amp;lt;parameter&amp;gt;
                &amp;lt;name&amp;gt;max&amp;lt;/name&amp;gt;
                &amp;lt;value&amp;gt;3&amp;lt;/value&amp;gt;
            &amp;lt;/parameter&amp;gt;
    &amp;lt;/ResourceParams&amp;gt;
&amp;lt;/Context&amp;gt;
</source>
           </subsection>
           
           <subsection name="4.6.3 EJB Applications" anchor="ejb">
           <p>To Be Done...</p>
           </subsection>
      
        </subsection>
    </section>
</body>
</document>
