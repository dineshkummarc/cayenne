<?xml version="1.0"?>

<!-- ========================================== -->
<!-- CayenneModeler tests subproject buildfile. -->
<!-- ========================================== -->
<project default="test">

    <property file="default.properties" />
	<property name="test.build" value="build/tests-modeler"/>
	<property name="test.output" value="${test.build}/out"/>
	<property name="test.report" value="${test.build}/report"/>
	<property name="test.filter" value="**/*Tst.class"/>
	
	<path id="classpath">
    	<fileset dir="${otherlib.dir}">
			<include name="${ant-junit.jar}"/>
			<include name="${emma.jar}"/>
			<include name="${emma.ant.jar}"/>
			<include name="${junit.jar}"/>
    	</fileset>
	   	<fileset dir="${ant.home}/lib" includes="ant*.jar,optional.jar"/>
		<fileset dir="${dist}/lib" includes="**/*.jar"/>
		
		<pathelement path="build/tests-modeler/classes"/>
		<pathelement path="build/tests/classes"/>
		<pathelement path="build/tests/deps"/>
		<pathelement path="${test.env.CLASSPATH}"/>
    </path>

	<!-- emma code coverage -->
	<property name="coverage.dir" value="${test.build}/coverage"/>
	<taskdef resource="emma_ant.properties" classpathref="classpath" />

	<target name="compile">
		<ant antfile="build-subproj.xml" target="compile">
			<property name="subproj" value="tests-modeler"/>
		</ant>
	</target>  
  
  
    <!-- ============================================= -->
    <!-- Runs and reports on tests.                    -->
    <!-- ============================================= -->
    <target name="test" depends="compile">
        <!-- Run Java on itself to avoid classloader weirdness in JUnit -->
    	<emmajava
    		enabled="${coverage.enabled}"
    		verbosity="quiet"
    		fork="true"
    		libclasspathref="classpath"
    		classname="org.apache.tools.ant.Main"
    		failonerror="true">

			<!-- sources to include -->
			<sourcepath>
				<pathelement path="src/cayenne/java"/>
				<pathelement path="src/modeler/java"/>
			</sourcepath>

    		<!-- modeler tests have no connection, so use test output dir -->
			<html
				outfile="${coverage.dir}/coverage.html"
				sort="+name, +line"
			/>

			<!-- do not instrument test classes -->
			<filter includes="org.objectstyle.cayenne.*"/>
			<filter	excludes="*Tst*,*Test*,*test*,org.objectstyle.cayenne.unit.*"/>

    		<arg value="-f"/>
    		<arg value="build-tests-modeler.xml"/>
    		<arg value="unit-test-report"/>

			<jvmarg value="-Xms64m"/>
			<jvmarg value="-Xmx64m"/>

			<sysproperty key="ant.home" value="${ant.home}"/>
			<sysproperty key="dist" value="${dist}"/>
			<sysproperty key="test.filter" value="${test.filter}"/>
			<classpath refid="classpath"/>
    	</emmajava>
    </target>    
    
    <!-- ============================================= -->
    <!-- Runs Unit tests.                              -->
    <!-- ============================================= -->
    <target name="unit-test">
        <delete>
        	<fileset dir="${basedir}">
        		<include name="${test.output}/**"/>
        		<include name="${test.report}/**"/>
        	</fileset>
        </delete>
        
        <mkdir dir="${test.output}"/>
        <mkdir dir="${test.report}"/>
        
        <junit fork="false" 
               haltonfailure="no" 
               errorProperty="test.modeler.failure"
               failureProperty="test.modeler.failure">
            
            <formatter type="xml" usefile="true"/>
            <batchtest todir="${test.output}">
                <fileset dir="${test.build}/classes">
                    <include name="${test.filter}"/>
                </fileset>
            </batchtest>
        </junit>
    </target>
    
    <!-- ============================================= -->
    <!-- Reports failures.                             -->
    <!-- ============================================= -->
    <target name="unit-test-report" depends="unit-test" if="test.modeler.failure">
    	<!-- HTML report is only generated on failures for speed -->
    	<junitreport todir="${test.report}">
			<fileset dir="${test.output}">
				<include name="TEST-*.xml"/>
			</fileset>
			<report format="frames" todir="${test.report}"/>
		</junitreport>
		
        <fail message="CayenneModeler tests failed, see files in ${test.output} for details"/>
    </target>
</project>

