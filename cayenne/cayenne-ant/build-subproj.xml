<?xml version="1.0"?>

<!-- ================================================= -->
<!--  Helper build file to compile subprojects.        -->
<!--                                                   -->
<!-- Depends on externally defined set of properties:  -->
<!-- - subproj                                         -->
<!-- - javacc.dir                                      -->
<!-- - javacc.grammar                                  -->
<!-- ================================================= -->
<project default="compile">
	
	
	
	<target name="prepare" depends="nosubproj">
		<tstamp/>
		<mkdir dir="${build}/${subproj}/properties"/>
		<mkdir dir="${build}/${subproj}/deps"/>
		<mkdir dir="${build}/${subproj}/classes"/>
		<mkdir dir="${dist}/src/${subproj}"/>
		<mkdir dir="${dist}/lib"/>
		<mkdir dir="${dist}/bin"/>
	</target>
	
	<target name="jjtree" depends="javacc-nodir,javacc-nogrammar,jjtree-uptodate"
		unless="jj.uptodate">
		<java dir="${basedir}" fork="true" classname="jjtree" failonerror="true">
			<classpath refid="javacc-classpath"/>
			<arg value="-OUTPUT_DIRECTORY:${parser.dir}"/>
			<arg value="${parser.dir}/${parser.base}.jjt"/>
		</java>
		
		<java dir="${basedir}" fork="true" classname="javacc" failonerror="true">
			<classpath refid="javacc-classpath"/>
			<arg value="-OUTPUT_DIRECTORY:${parser.dir}"/>
			<arg value="${parser.dir}/${parser.base}.jj"/>
		</java>
	</target>
	
	<target name="jjdoc"
		depends="jjtree,javacc-nodir,javacc-nogrammar,jjdoc-uptodate"
		unless="jjdoc.uptodate">
		<!-- this property may be reset by the caller. -->
		<property name="parser.doc.dir" value="${parser.dir}"/>
		<java dir="${basedir}" fork="true" classname="jjdoc" failonerror="true">
			<classpath refid="javacc-classpath"/>
			<arg value="-OUTPUT_FILE:${parser.doc.dir}/${parser.base}.html"/>
			<arg value="${parser.dir}/${parser.base}.jj"/>
		</java>
	</target>
	
	<target name="jjtree-uptodate" depends="javacc-nodir,javacc-nogrammar">
		<uptodate property="jj.uptodate"
			targetfile="${parser.dir}/${parser.base}.jj"
			srcfile="${parser.dir}/${parser.base}.jjt"/>
	</target>
	
	<target name="jjdoc-uptodate" depends="javacc-nodir,javacc-nogrammar">
		<uptodate property="jjdoc.uptodate"
			targetfile="${parser.doc.dir}/${parser.base}.html"
			srcfile="${parser.dir}/${parser.base}.jj"/>
	</target>
	
	<target name="javacc" depends="javacc-nodir,javacc-nogrammar">
		<java dir="${basedir}" fork="true" classname="javacc" failonerror="true">
			<classpath refid="javacc-classpath"/>
			<arg value="-OUTPUT_DIRECTORY:${parser.dir}"/>
			<arg value="${parser.dir}/${parser.base}.jj"/>
		</java>
	</target>
	
	<target name="javacc-nodir" unless="parser.dir">
		<fail>"parser.dir" is undefined.</fail>
	</target>
	
	<target name="javacc-nogrammar" unless="parser.base">
		<fail>"parser.base" is undefined.</fail>
	</target>
	
	<target name="nosubproj" unless="subproj">
		<fail>"subproj" is undefined.</fail>
	</target>
</project>
