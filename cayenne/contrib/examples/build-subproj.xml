<?xml version="1.0"?>

<!-- ================================================= -->
<!--  Helper build file to compile subprojects.        -->
<!--                                                   -->
<!-- Depends on externally defined set of properties:  -->
<!--   - subproj                                       -->
<!--                                                   -->
<!-- ================================================= -->
<project name="java-subproj" default="compile">
	<property name="dist-subproj" value="${dist.base}/${project.name}-${project.version}/${subproj}"/>

	<!-- ========================================== -->
    <!-- Build paths's for subprojects.             -->
    <!-- ========================================== -->    
	<path id="classpath-base">
		<pathelement path="${cayenne.dir}/${cayenne.jar}"/>
    </path>
    
    <path id="classpath-data-port">
		<path refid="classpath-base"/>
    </path>
    
    <path id="classpath-docs">
    	<pathelement path="${ant.home}/lib/ant.jar"/>
        <fileset dir="${root}/otherlib">
            <include name="**.jar"/>
        </fileset>
    </path>
	
	<target name="prepare" depends="nosubproj">
		<tstamp/>
		<mkdir dir="build/${subproj}/properties"/>
		<mkdir dir="build/${subproj}/deps"/>
		<mkdir dir="build/${subproj}/classes"/>
		<mkdir dir="${dist-subproj}/src/${subproj}"/>
		<mkdir dir="${dist-subproj}/lib"/>
		<mkdir dir="${dist-subproj}/bin"/>
		<mkdir dir="${dist-subproj}/doc/api"/>
	</target>
	
	<!-- ========================================== -->
    <!-- Builds Subproject documenatation.          -->
    <!-- ========================================== -->
    <target name="doc" depends="prepare">
        <taskdef name="anakia" classname="org.apache.velocity.anakia.AnakiaTask">
            <classpath refid="classpath-docs"/>
        </taskdef>
        
        <!-- Build site -->
        <anakia basedir="xdocs/${subproj}" destdir="${dist-subproj}/doc"
             extension=".html" 
             style="xdocs/stylesheets/cayenne.vsl"
             projectFile="contrib/examples/xdocs/stylesheets/project.xml"
             excludes="**/stylesheets/**"
             includes="**/*.xml"
             lastModifiedCheck="true"
             templatePath="${root}"/>
    </target>    
    
    <!-- ========================================== -->
    <!-- Copies documentation images in the target  -->
    <!-- directory.                                 -->
    <!-- ========================================== -->
    <target name="doc-img">
        <!-- copy images -->
        <copy todir="${dist}/doc/images" filtering="no">
            <fileset dir="xdocs/images">
                <include name="**/*.gif"/>
                <include name="**/*.jpeg"/>
                <include name="**/*.png"/>
                <include name="**/*.jpg"/>
                <include name="**/*.css"/>
            </fileset>
        </copy>
        
        <!-- copy modeler buttons -->
        <mkdir dir="${dist}/doc/images/modeler"/>
        <copy todir="${dist}/doc/images/modeler" filtering="no" flatten="yes">
            <fileset dir="src/modeler/java">
                <include name="**/*.gif"/>
                <include name="**/*.jpeg"/>
                <include name="**/*.png"/>
                <include name="**/*.jpg"/>
            </fileset>
        </copy>
    </target>

	<target name="compile" depends="nosubproj,prepare">
		<javac	srcdir="${subproj}/src/java" 
				destdir="build/${subproj}/classes"
				deprecation="on">
			<classpath refid="classpath-${subproj}"/>
		</javac>
	</target>
	
	<target name="nosubproj" unless="subproj">
		<fail>"subproj" is undefined.</fail>
	</target>
	
	
	<!-- ========================================== -->
    <!-- Lazy API documenatation build.             -->
    <!-- ========================================== -->
    <target name="api" depends="nosubproj,check-api,build-api"/>
    
    <target name="build-api" depends="prepare" unless="api.up2date">
        <javadoc    packagenames="org.objectstyle.*"
                    sourcepath="${subproj}/src/java"
                    defaultexcludes="yes"
                    destdir="${dist-subproj}/doc/api"
                    author="true"
                    use="true"
                    splitindex="true"
                    windowtitle="Cayenne API"
                    overview="${subproj}/src/java/overview.html">
            
            <bottom><![CDATA[<!--SFLOGO--> &nbsp; <i>Copyright &#169; 2001-2002 <a href=
            "http://objectstyle.org" target="_top">ObjectStyle.org</a> All Rights Reserved.</i>]]>
            </bottom>
            <classpath refid="classpath-${subproj}"/>
        </javadoc>
    </target>
    
    <target name="check-api">
		<uptodate property="api.up2date" targetfile="${dist-subproj}/doc/api/index.html" >
			<srcfiles dir= "${subproj}/src/java" includes="**/*.java"/>
		</uptodate>
    </target>
</project>
